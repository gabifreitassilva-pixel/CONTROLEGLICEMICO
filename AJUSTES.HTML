<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlicoGabi - Ajustes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primaria: #7e57ff; --lavanda-claro: #f4f0ff; --azul-planilha: #008eb4; }
        body { font-family: 'Segoe UI', sans-serif; background: white; margin: 0; padding: 0; }
        .container { width: 100%; min-height: 100vh; padding-bottom: 30px; display: flex; flex-direction: column; }
        .header { background: var(--primaria); color: white; text-align: center; padding: 15px; }
        .tabs { display: flex; background: var(--lavanda-claro); margin: 10px 15px; border-radius: 12px; padding: 5px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: bold; color: var(--primaria); cursor: pointer; border-radius: 8px; }
        .tab-btn.active { background: white; box-shadow: 0 2px 5px rgba(0,0,0,.1); }
        .section-box { background: var(--lavanda-claro); margin: 0 15px 15px; padding: 15px; border-radius: 20px; border: 1px solid #e3d9ff; }
        input, select { padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 14px; width: 100%; margin-bottom: 10px; }
        .btn-acao { background: var(--primaria); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 8px; }
        .btn-pdf { background: #9b59b6; } .btn-wpp { background: #25d366; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th { background: var(--primaria); color: white; padding: 10px; font-size: 11px; text-align: left; }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; font-size: 14px; }
        .hidden { display: none !important; }
        
        /* Estilo da Planilha Modelo */
        #modalRelatorio { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: none; overflow: auto; }
        .rel-topo { background: var(--primaria); color: white; padding: 15px; display: flex; justify-content: space-between; position: sticky; top: 0; }
        .folha { padding: 5mm; width: 287mm; margin: auto; background: white; color: black; }
        .titulo-planilha { color: var(--azul-planilha); text-align: center; font-size: 22pt; font-weight: bold; margin-bottom: 10px; }
        .tab-rel { width: 100%; border-collapse: collapse; font-size: 9pt; }
        .tab-rel th { border: 1px solid #ccc; padding: 8px; background: white; color: var(--azul-planilha); text-align: center; font-weight: bold; }
        .tab-rel td { border: 1px solid #ccc; padding: 5px; text-align: center; color: #555; height: 8mm; }
    </style>
</head>
<body>
<div class="container">
    <div class="header"><h3>Ajustes GlicoGabi</h3></div>
    <div class="tabs">
        <button id="btnDoses" class="tab-btn active" onclick="toggleAba('doses')">Relatório & Doses</button>
        <button id="btnConfig" class="tab-btn" onclick="toggleAba('config')">Configurar Insulinas</button>
    </div>

    <div id="abaDoses">
        <label style="font-size:10px; font-weight:bold; color:var(--primaria); margin-left:20px">GERAR PLANILHA DE CONTROLE</label>
        <div class="section-box" style="margin-top:5px">
            <input type="text" id="wppInput" placeholder="WhatsApp (DDD + Número)" onchange="salvarWpp()">
            <div style="display: flex; gap: 5px;">
                <select id="selMes" style="flex: 2;">
                    <option value="01">Janeiro</option><option value="02">Fevereiro</option>
                    <option value="03">Março</option><option value="04">Abril</option>
                    <option value="05">Maio</option><option value="06">Junho</option>
                    <option value="07">Julho</option><option value="08">Agosto</option>
                    <option value="09" selected>Setembro</option><option value="10">Outubro</option>
                    <option value="11">Novembro</option><option value="12">Dezembro</option>
                </select>
                <input type="number" id="selAno" style="flex: 1;" value="2026">
            </div>
            <button class="btn-acao" onclick="verRelatorio()">1. Gerar Planilha com Dados da Home</button>
            <button class="btn-acao btn-pdf" onclick="exportarPDF()">2. Baixar PDF da Planilha</button>
            <button class="btn-acao btn-wpp" onclick="enviarWpp()">3. Enviar por WhatsApp</button>
        </div>

        <label style="font-size:10px; font-weight:bold; color:var(--primaria); margin-left:20px">INSULINAS ATUAIS</label>
        <div class="section-box" style="padding:5px">
            <table><thead><tr><th>Tipo</th><th>Dose</th><th>Ações</th></tr></thead><tbody id="listaMeds"></tbody></table>
        </div>
    </div>

    <div id="abaConfig" class="hidden">
        <div class="section-box">
            <input type="hidden" id="editIdx" value="-1">
            <input type="text" id="nomeMed" placeholder="Ex: Insulina NPH">
            <input type="text" id="qtdMed" placeholder="Ex: 12 UI - Manhã">
            <button class="btn-acao" onclick="salvarDose()">Salvar Medicação</button>
        </div>
    </div>
</div>

<div id="modalRelatorio">
    <div class="rel-topo"><b>PLANILHA DE CONTROLE</b><button onclick="fecharRelatorio()" style="background:white; border:none; border-radius:5px; padding:5px 10px; color:var(--primaria); font-weight:bold;">X FECHAR</button></div>
    <div id="areaRel" class="folha">
        <div class="titulo-planilha">Controle de Glicêmico</div>
        <table class="tab-rel">
            <thead>
                <tr>
                    <th style="width:15mm">Data</th>
                    <th>Glicemia Jejum</th>
                    <th>Glicemia 2h após café</th>
                    <th>Glicemia antes do almoço</th>
                    <th>Glicemia 2h após almoço</th>
                    <th>Glicemia antes do Jantar</th>
                    <th>Glicemia 2h após o Jantar</th>
                    <th>Glicemia ao deitar</th>
                    <th>Glicemia as 3:00</th>
                </tr>
            </thead>
            <tbody id="corpoRel"></tbody>
        </table>
    </div>
</div>

<script>
    let dbDoses = JSON.parse(localStorage.getItem('gabi_ajustes_vFinal')) || [];
    const BANCO_HOME = "gabi_database_v1";

    function toggleAba(aba) {
        document.getElementById('abaDoses').classList.toggle('hidden', aba !== 'doses');
        document.getElementById('abaConfig').classList.toggle('hidden', aba !== 'config');
        document.getElementById('btnDoses').classList.toggle('active', aba === 'doses');
        document.getElementById('btnConfig').classList.toggle('active', aba === 'config');
        if(aba === 'doses') renderDoses();
    }

    function verRelatorio() {
        const mesSel = document.getElementById('selMes').value;
        const anoSel = document.getElementById('selAno').value;
        const historico = JSON.parse(localStorage.getItem(BANCO_HOME) || '[]');
        
        let html = "";
        for(let dia = 1; dia <= 31; dia++) {
            const diaFormatado = dia.toString().padStart(2, '0');
            const dataFiltro = `${anoSel}-${mesSel}-${diaFormatado}`;
            
            const registrosDia = historico.filter(reg => reg.data === dataFiltro);
            const buscar = (m) => registrosDia.find(r => r.momento === m)?.valor || "";

            html += `<tr>
                <td style="background:#f9f9f9; font-weight:bold;">${diaFormatado}/${mesSel}</td>
                <td>${buscar('Jejum')}</td>
                <td>${buscar('Pós café')}</td>
                <td>${buscar('Antes do almoço')}</td>
                <td>${buscar('Depois do almoço')}</td>
                <td>${buscar('Antes da janta')}</td>
                <td>${buscar('Depois da janta')}</td>
                <td>${buscar('Antes de Dormir')}</td>
                <td>${buscar('Madrugada')}</td>
            </tr>`;
        }
        document.getElementById('corpoRel').innerHTML = html;
        document.getElementById('modalRelatorio').style.display = "block";
    }

    function fecharRelatorio() { document.getElementById('modalRelatorio').style.display = "none"; }

    function exportarPDF() {
        verRelatorio();
        const element = document.getElementById('areaRel');
        const opt = { margin: [0,0,0,0], filename: `Controle_Glicemia_${document.getElementById('selMes').value}.pdf`, jsPDF: { orientation: 'landscape', unit: 'mm', format: 'a4' } };
        html2pdf().from(element).set(opt).save();
    }

    // Funções de Gerenciamento de Doses
    function salvarDose() {
        const nome = document.getElementById('nomeMed').value;
        const qtd = document.getElementById('qtdMed').value;
        if(!nome || !qtd) return alert("Preencha!");
        dbDoses.push({nome, qtd});
        localStorage.setItem('gabi_ajustes_vFinal', JSON.stringify(dbDoses));
        toggleAba('doses');
    }

    function renderDoses() {
        document.getElementById('listaMeds').innerHTML = dbDoses.map((m, i) => `<tr><td>${m.nome}</td><td>${m.qtd}</td><td><button onclick="dbDoses.splice(${i},1); localStorage.setItem('gabi_ajustes_vFinal', JSON.stringify(dbDoses)); renderDoses();">❌</button></td></tr>`).join('');
    }

    window.onload = renderDoses;
</script>
</body>
</html>
